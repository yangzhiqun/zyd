<style type="text/css">
  ul.data-tabs li {
    display: inline-block;
  }

  ul.data-tabs {
    border-bottom: 1px solid #999;
    padding-left: 15px;
    position: relative;
  }

  ul.data-tabs a {
    display: inline-block;
    color: black;
    text-decoration: none;
    border: 1px solid #999;
    padding: 5px 10px;
    position: relative;
    bottom: -1px;
  }

  ul.data-tabs a.active {
    border-bottom: 1px solid #FFFFFF;
  }

  .cjbh .label {
    margin: 5px auto;
    display: block;
  }
</style>
<script type="text/javascript">
  $(function () {
    $('body').delegate('#select-all', 'click', function () {
      var o = $(this);
      if (o.is(':checked')) {
        $('.yycz-list tbody input[type="checkbox"]').attr('checked', 'checked');
      } else {
        $('.yycz-list tbody input[type="checkbox"]').removeAttr('checked');
      }
    });
    $('#assign-task').click(function () {
      var yycz_ids = [];
      $.each($('.yycz-list tbody .checkbox:checked'), function () {
        yycz_ids.push($(this).attr('data-id'));
      });
      if (yycz_ids.length == 0 || $('.task-info #czbm').val() == '' || $('.task-info #czfzr').val() == '') {
        alert('请选择、填写完整信息');
      } else {
        var ids_str = yycz_ids.join(',');
        $.post('/wtyp_assign_task.json', {
          ids: ids_str,
          czbm: $('.task-info #czbm').val(),
          czfzr: $('.task-info #czfzr').val()
        }, function (data) {
          if (data.status == 'OK') {
            location.reload();
          } else {
            alert("错误！ERR: " + data.msg);
          }
        });
      }
      return false;
    });
    $("#czbm").change(function () {
      var v = $(this).val();
      $.get("/users_by_jcjg.json", {jcjg: v, model: "wtyp_czb"}, function (data) {
        console.log(data);
        if (data.status == 'OK') {
          $('#czfzr').empty();
          $.each(data.msg, function (i, user) {
            $('<option value="' + user.id + '">' + user.tname + '</option>').appendTo($('#czfzr'));
          });
        } else {
          alert("获取用户失败");
        }
      }, 'json');
    }).trigger("change");

    // 退回
    $("#revert").click(function () {
      var thyy = $('#thyy').val();

      var yycz_ids = [];
      $.each($('.yycz-list tbody .checkbox:checked'), function () {
        yycz_ids.push($(this).attr('data-id'));
      });

      if (yycz_ids.length == 0) {
        alert("请选择要退回的项");
        return false;
      }

      if (thyy == '') {
        alert('请填写退回原因');
      } else {
        $.post("/wtyp_czb_revert.json", {
          ids: yycz_ids.join(','),
          thyy: thyy,
          is_ap: <%= params[:state].to_i == 0 %>
        }, function (data) {
          if (data.status == 'OK') {
            alert("退回成功!");
            location.reload();
          } else {
            alert("退回失败！ERR: " + data.msg);
          }
        }, 'json');
      }
    });

    $('.yycz-list tbody .dopreview').click(function () {
      var o = $(this);
      $('#preview').attr("src", "/wtyp_czbs/" + o.attr('data-id') + "/edit?preview=true");
    });

    $('.yycz-list tbody .dopreview:first').trigger("click");

    $("#preview").load(function () {
      $(this).height($(this).contents().find("body").height());
    });
  });
</script>

<% if params[:state].to_i == 0 %>
    <h2>
      <center>核查处置工作安排</center>
    </h2>
<% elsif params[:state].to_i == 1 %>
    <h2>
      <center>核查处置工作填报</center>
    </h2>
<% elsif params[:state].to_i == 2 %>
    <h2>
      <center>核查处置工作审核</center>
    </h2>
<% end %>
<br>
<form action="/wtyp_czbs_by_state/<%= params[:state].to_i %>" method="GET">
  <table class="table table-bordered table-condensed table-sm">
    <tr>
      <td colspan="4">填报起始日期</td>
      <td colspan="6">
        <input type="text" class="form-control input-sm datepicker" name="begin_at" value=<%= @begin_at %>></td>
      <td colspan="4">至填报结束日期</td>
      <td colspan="6">
        <input type="text" class="form-control input-sm datepicker" name="end_at" value=<%= @end_at %>></td>
      <td colspan="4">样品名称</td>
      <td colspan="6"><input class="form-control input-sm" type="text" value="<%= params[:ypmc] %>" name="ypmc">
      </td>
    </tr>
    <tr>
      <td colspan="4">被抽样单位名称</td>
      <td colspan="6"><input class="form-control input-sm" type="text" value="<%= params[:bcydwmc] %>" name="bcydwmc">
      </td>
      <td colspan="4">被抽样单位市/区</td>
      <td colspan="6">
        <select name="bcydw_sheng" class="form-control input-sm">
          <option value="">请选择</option>
          <% SysProvince.level1.each do |prov| %>
              <option value="<%= prov.name %>"><%= prov.name %></option>
          <% end %>
        </select>
      </td>
      <td colspan="4">任务来源</td>
      <td colspan="6">
        <%= select_tag :rwly, options_for_select([["请选择", ""], ["局本级", 1], ["中央转移地方", 2]], params[:rwly].to_i), :class => "form-control input-sm" %>
      </td>
    </tr>
    <tr>
      <td colspan="4">标识生产企业名称</td>
      <td colspan="6"><input class="form-control input-sm" type="text" value="<%= params[:bsscqymc] %>" name="bsscqymc">
      </td>
      <td colspan="4">标示生产企业市/区</td>
      <td colspan="6">
        <select name="sp_s_220" class="form-control input-sm">
          <option value="">请选择</option>
          <% SysProvince.level1.each do |prov| %>
              <option value="<%= prov.name %>"><%= prov.name %></option>
          <% end %>
        </select>
      </td>
      <td colspan="4">采样编号</td>
      <td colspan="6"><input class="form-control input-sm" type="text" value="<%= params[:cjbh] %>" name="cjbh">
      </td>
    </tr>
  </table>
  <input type="hidden" value="<%= params[:current_tab] %>" name="current_tab">
  <button type="submit" class="btn btn-primary btn-sm">搜索</button>
</form>
<!--<iframe id="preview" src="" height="0" width="100%" frameborder="0"></iframe>-->
<% if params[:state].to_i == 0 %>
    <table class="task-info table table-bordered">
      <tbody>
      <!--<tr>
      <th class="col-md-2">处置部门</th>
      <td>
        <%= select_tag :czbm, options_for_select(JgBsb.where("status = 0 and jg_province = ?", current_user.user_s_province).map { |u| [u.jg_name, u.jg_name] }), :id => 'czbm', :style => "width: 180px;", :class => "form-control input-sm" if false %>
      </td>
      <th>处置责任人</th>
      <td><select name="czfzr" id="czfzr" class="form-control input-sm"></select></td>
    </tr>-->
      </tbody>
    </table>
<% end %>
<% if [::WtypCzb::State::LOGGED, ::WtypCzb::State::ASSIGNED].include? params[:state].to_i %>
    <br>
    <ul class="data-tabs">
      <li>
        <a href="?<%= generate_tab_params(0) %>" class="<%= "active" if params[:current_tab].to_i == 0 %>">24小时限时报告</a>
      </li>
      <li><a href="?<%= generate_tab_params(1) %>" class="<%= "active" if params[:current_tab].to_i == 1 %>">一般不合格报告</a>
      </li>
      <li><a href="?<%= generate_tab_params(4) %>" class="<%= "active" if params[:current_tab].to_i == 4 %>">一般问题报告</a>
      </li>

      <% if params[:state].to_i == 1 %>
          <li><a href="?<%= generate_tab_params(6) %>" class="<%= "active" if params[:current_tab].to_i == 6 %>">办理中</a>
          </li>
      <% end %>

      <% if [::WtypCzb::State::LOGGED].include? params[:state].to_i %>
          <li><a href="?<%= generate_tab_params(3) %>" class="<%= "active" if params[:current_tab].to_i == 3 %>">已安排</a>
          </li>
      <% else %>
          <li><a href="?<%= generate_tab_params(3) %>" class="<%= "active" if params[:current_tab].to_i == 3 %>">已办结</a>
          </li>
      <% end %>

      <% if [::WtypCzb::State::LOGGED].include? params[:state].to_i %>
          <li>
            <a href="?<%= generate_tab_params(5) %>" class="<%= "active" if params[:current_tab].to_i == 5 %>">处置完毕</a>
          </li>
      <% end %>

    </ul>
<% else
     params[:state].to_i == ::WtypCzb::State::FILLED %>
    <br>
    <ul class="data-tabs">
      <li><a href="?<%= generate_tab_params(0) %>" class="<%= "active" if params[:current_tab].to_i == 0 %>">未审核</a>
      </li>
      <li><a href="?<%= generate_tab_params(1) %>" class="<%= "active" if params[:current_tab].to_i == 1 %>">审核完毕</a>
      </li>
    </ul>
<% end %>
<div class="tab-content">
  <br>
  <% if @wtyp_czbs.nil? %>
      <p>暂无未安排数据</p>
  <% else %>
      <% if WtypCzbPart.revert_enabled?(params[:current_tab].to_i, params[:state].to_i, current_user) %>
          <div class="well well-sm">
            <div class="input-group">
              <input type="text" class="form-control" name="thyy" width="300px;" id="thyy" placeholder="请填写退回原因">
				<span class="input-group-btn">
					<button class="btn btn-danger" id="revert" type="button">退回</button>
				</span>
            </div>
          </div>
      <% end %>
      <table
      data-toggle="table"
      data-reorderable-columns="true"
      class="yycz-list ">
        <thead>
        <tr>
          <th width="30" align="center"><input type="checkbox" id="select-all"></th>
          <!-- <th width="50">#</th> -->
          <th>采样编号</th>
          <th>抽样环节</th>
          <th>样品名称</th>
          <th>标示生产企业市/区</th>
          <th>被抽样单位市/区</th>
          <th>标示生产企业名称</th>
          <th>检验结论</th>
          <th>检验结果状态</th>
          <th>异议状态</th>
          <th>收到检验报告日期</th>
          <th>启动核查处置日期</th>
        </tr>
        </thead>
        <tbody>
        <% if params[:state].to_i == 0 and ![3, 5].include? params[:current_tab].to_i %>
            <% @sp_bsbs.each_with_index do |bsb, index| %>
                <tr>
                  <td align="center">
                    <input class="checkbox" type="checkbox" data-id="<%= bsb.id %>">
                  </td>
                  <td class="cjbh">
                    <a title="<%= bsb.sp_s_16 %>" href="/wtyp_czbs/<%= bsb.id %>/edit"><%= bsb.sp_s_16 %></a>

                    <% if Time.now - bsb.updated_at > 5.days %>
                        <span class="label label-info">未产品控制</span>
                    <% end %>

                    <% if Time.now - bsb.updated_at > 30.days %>
                        <span class="label label-warning">未排查整改</span>
                    <% end %>

                    <% if Time.now - bsb.updated_at > 90.days %>
                        <span class="label label-danger">未行政处罚</span>
                    <% end %>
                  </td>
                  <td><%= bsb.sp_s_68 %></td>
                  <td><%= bsb.sp_s_14 %></td>
                  <td><%= bsb.sp_s_220 %></td>
                  <td><%= bsb.sp_s_4 %></td>
                  <td><%= bsb.sp_s_64 %></td>
                  <td><%= bsb.sp_s_71 %></td>
                  <td><%= bsb.yydjb.blank? ? "初检结论" : bsb.yydjb.fjzt %></td>
                  <td><%= bsb.yydjb.blank? ? "逾期未提出异议" : bsb.yydjb.yyczjg %></td>
                  <td>-</td>
                  <td>-</td>
                </tr>
            <% end %>
        <% else %>
            <% @wtyp_czbs.each_with_index do |wtyp_czb, index| %>
                <% if wtyp_czb.sp_bsb.nil? %>
                    <tr class="warning">
                      <td></td>
                      <td colspan="11"><span class="text-danger"><%= wtyp_czb.cjbh %></span><br>无法找到对应的抽样信息</td>
                    </tr>
                <% else %>
                    <tr class="<%= wtyp_czb.deadline_warning %>">
                      <td align="center">
                        <% if wtyp_czb.count == 1 %>
                            <% if wtyp_czb.wtyp_czb_type == ::WtypCzbPart::Type::SC %>
                                <input class="checkbox" <%= "disabled" if current_user.hcz_admin == 0 and !current_user.user_s_province.eql?(wtyp_czb.bsscqy_sheng) %> type="checkbox" data-id="<%= wtyp_czb.id %>">
                            <% else %>
                                <input class="checkbox" <%= "disabled" if current_user.hcz_admin == 0 and !current_user.user_s_province.eql?(wtyp_czb.bcydw_sheng) %> type="checkbox" data-id="<%= wtyp_czb.id %>">
                            <% end %>
                        <% else %>
                            <% WtypCzbPart.where(sp_bsb_id: wtyp_czb.sp_bsb_id).select('id, wtyp_czb_type, bsscqy_sheng, bcydw_sheng').each do |c| %>
                                <% if c.wtyp_czb_type == ::WtypCzbPart::Type::SC %>
                                    <input class="checkbox" <%= "disabled" if current_user.hcz_admin == 0 and !current_user.user_s_province.eql?(c.bsscqy_sheng) %> type="checkbox" data-id="<%= c.id %>">生产
                                <% else %>
                                    <input class="checkbox" <%= "disabled" if current_user.hcz_admin == 0 and !current_user.user_s_province.eql?(c.bcydw_sheng) %> type="checkbox" data-id="<%= c.id %>">消费
                                <% end %>
                            <% end %>
                        <% end %>
                      </td>
                      <!-- <td><a data-id="<%= wtyp_czb.sp_bsb_id %>" href="javascript:void(0);" class="dopreview btn btn-link btn-xs center-block">预览</a></td> -->
                      <td width="200" class="cjbh">
                        <a title="<%= wtyp_czb.cjbh %>" class="text-<%= wtyp_czb.deadline_warning %>" href="/wtyp_czbs/<%= wtyp_czb.sp_bsb_id %>/edit"><%= wtyp_czb.cjbh %></a>

                        <% if Time.now - SpBsb.find(wtyp_czb.sp_bsb_id).updated_at > 5.days and !wtyp_czb.part_submit_flag1 %>
                            <span class="label label-info">未产品控制</span>
                        <% end %>

                        <% if Time.now - SpBsb.find(wtyp_czb.sp_bsb_id).updated_at > 30.days and !wtyp_czb.part_submit_flag2 %>
                            <span class="label label-warning">未排查整改</span>
                        <% end %>

                        <% if Time.now - SpBsb.find(wtyp_czb.sp_bsb_id).updated_at > 90.days and !wtyp_czb.part_submit_flag3 %>
                            <span class="label label-danger">未行政处罚</span>
                        <% end %>
                      </td>
                      <td><%= wtyp_czb.cydd %></td>
                      <td><%= wtyp_czb.ypmc %></td>
                      <td><%= wtyp_czb.bsscqy_sheng %></td>
                      <td><%= wtyp_czb.bcydw_sheng %></td>
                      <td><%= wtyp_czb.bsscqymc %></td>
                      <td><%= wtyp_czb.jyjl %></td>
                      <td><%= wtyp_czb.yydjb.yyczzt unless wtyp_czb.yydjb.nil? %></td>
                      <td><%= wtyp_czb.yydjb.blank? ? "逾期未提出异议" : wtyp_czb.yydjb.yyczjg %></td>
                      <td><%= wtyp_czb.wtyp_date %></td>
                      <td><%= wtyp_czb.qdhcczrq %></td>
                    </tr>
                <% end %>
            <% end %>
        <% end %>
        </tbody>
      </table>
      <% if params[:state].to_i == 0 and ![3, 5].include? params[:current_tab].to_i %>
          <p><%= will_paginate @sp_bsbs, :params => params, :separator => ',', :previous_label => '上一页', :next_label => '下一页' %></p>
      <% else %>
          <p><%= will_paginate @wtyp_czbs, :params => params, :separator => ',', :previous_label => '上一页', :next_label => '下一页' %></p>
      <% end %>
      <br>
      <% if params[:state].to_i == 0 and ![3, 5].include? params[:current_tab].to_i %>
          <!--<button class="btn btn-primary" id="assign-task">确认处置安排</button>-->
      <% end %>
  <% end %>
</div>
