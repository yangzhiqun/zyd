<script type="text/javascript">
  $(function () {
//    reload_jg_data();
    $('a.unbind').click(function () {
      $('#user_id_card, .id-card, #user_user_sign').val('');
      $('img#ca-sign').attr('src', '');
      $('.id-card').html("<b class='text-danger'>无</b>");
      return false;
    });
    $('.pass-request').click(function () {
      var o = $(this);
      if (o.hasClass('pass')) {
        $('#account-pass-flag').val(1);
      } else if (o.hasClass('deny')) {
        $('#account-pass-flag').val(0);
      }
    });
    $('#user_jg_bsb_id').select2();
//    $(".region").ProvinceCity({
//      dprovince: "%= is_ejz? ? SysConfig.get(SysConfig::Key::PROV) : @user.user_s_province %>"
//     dcity: "%= @user.prov_city %>",
//      lcity: "%= @user.prov_country %>"
//    });
    $('#province').append("<option value='<%=@user.user_s_province %>'><%=@user.user_s_province %></option>");
    $.get('/prov.json', {prov: <%= @province.id %>}, function (data) {

     $('<option>-请选择-</option>').appendTo($('#city'));
      $.each(data.msg, function (i, item) {
        $('<option>').attr({'value': item.name, 'data-id': item.id}).text(item.name).appendTo($('#city'));
      });
    }, 'json');


    $('#city').change(function () {
      var o = $(this);

      $('#lcity').empty();
      $('<option>-请选择-</option>').appendTo($('#lcity'));

      $.get('/prov.json', {city: o.find('option:selected').attr('data-id')}, function (data) {
        $.each(data.msg, function (i, item) {
          $('<option>').attr({'value': item.name, 'data-id': item.id}).text(item.name).appendTo($('#lcity'));
        });
      }, 'json');
   });
    $('#city').change(function () {
      reload_jg_data();

    });
  });

  function reload_jg_data() {
    $.get('/jg_bsbs/by_jg_name.json', {
     city:  $('#city').val()
    }, function (data) {
      if (data.status == 'OK') {
        $('#user_jg_bsb_id').empty();
        $.each(data.msg, function (index, item) {
          $("<option>").attr({'value': item[1]}).text(item[0]).appendTo($('#user_jg_bsb_id'));
        });
        $('#user_jg_bsb_id').select2({theme: 'bootstrap', placeholder: '请选择所在机构'});
      }
    }, 'json');
  }
</script>
<div class="row" style="margin: 0;">
  <div class="col-sm-6 col-sm-offset-3">
    <%= form_for(@user, url: @user.new_record? ? '/manager_create_users' : "/users/#{@user.id}") do |f| %>
        <div class="text-danger"><%= flash[:notice] %></div>
        <% if @user.new_record? %>
            <h4>创建用户</h4>
        <% else %>
            <h4>修改用户</h4>
        <% end %>
        <hr>
        <label for="">UID：<%= @user.uid %></label><br>

        <% unless @user.user_sign.blank? %>
            <label for="">CA签名：</label>
            <img id="ca-sign" src="data:image/png;base64,<%= @user.user_sign %>" alt="签名"><br><br>
            <%= f.hidden_field :user_sign, :class => "form-control input-sm" %>
        <% end %>

        <br>
        <label>请输入密码：<%= show_error(@user.errors, :password) %></label>
        <%= f.password_field :password, :class => "form-control input-sm" %>

        <br>
        <label>请再次输入密码：</label>
        <%= f.password_field :password_confirmation, :class => "form-control input-sm" %>

        <br>
        <label>姓名：</label>
        <%= f.text_field :tname, :class => "form-control input-sm" %>

        <br>
        <label>身份证号：</label><span class="id-card"><%= @user.id_card.blank? ? '无' : @user.id_card %></span><a class="btn text-danger btn-xs unbind" href="">解绑</a>
        <br>
        <%= f.hidden_field :id_card, :class => "form-control input-sm" %>

        <br>
        <label>联系电话：</label>
        <%= f.text_field :tel, :class => "form-control input-sm" %>

        <br>
        <label>手机号：</label>
        <%= f.text_field :mobile, :class => "form-control input-sm" %>

        <br>
        <label>电子邮箱：</label>
        <%= f.text_field :eaddress, :class => "form-control input-sm" %>

        <br>
        <label>所在省份：</label>

        <% if current_user.is_super? or current_user.is_prov_manager? %>
            <div class="region form-inline">
              <%= @user.user_s_province %>
              <%= f.select :user_s_province, '', {}, :class => 'hidden', :id => 'province' %>
							<%= f.select :prov_city, '', {}, :class => 'form-control input-sm', :id => 'city' %>
              <%= f.select :prov_country, '', {}, :class => 'form-control input-sm', :id => 'lcity' %>
            </div>
        <% else %>
            <%= "#{@user.user_s_province}/#{@user.prov_city}/#{@user.prov_country}" %>
        <% end %>

        <br>
        <% if current_user.is_super? or current_user.is_prov_manager? %>
            <label>机构名称：</label>
            <!--%= f.select :jg_bsb_id, options_for_select(JgBsb.list_jgbsb(SysConfig.get(SysConfig::Key::PROV)).map { |jg| [jg.jg_name, jg.id] }.unshift(["请选择", nil]), @user.jg_bsb_id), {}, :class => "form-control input-sm" %>-->
            <%= f.select :jg_bsb_id, options_for_select(JgBsb.where(status: 0).map { |jg| [jg.jg_name, jg.id] }, @user.jg_bsb_id), {}, :class => "form-control input-sm" %>
            <!--%= f.select :jg_bsb_id, [], {},:class => "form-control input-sm" %>-->
            <% if current_user.is_admin? or current_user.is_account_manager %>
                <div class="form-inline">
                  <div class="checkbox">
                    <label><%= f.check_box :is_account_manager, options = {}, checked_value = "1", unchecked_value = "0" %>
                      是否为账号管理员</label></div>
                </div>
            <% end %>
        <% else %>
            <label for="">机构名称：<%= @user.jg_bsb.jg_name %></label>
        <% end %>

        <% if current_user.is_account_manager? or current_user.name == 'superadmin' %>
            <% if current_user.is_super? %>
                <div class="form-inline">
                  <div class="checkbox">
                    <label>
                      <%= f.check_box :user_i_js, options = {}, checked_value = "1", unchecked_value = "0" %>
                      是否为地方药监局
                    </label>
                  </div>
                  <!--div class="checkbox">
                    <label>
                      <%= f.check_box :user_i_spys, options = {}, checked_value = "1", unchecked_value = "0" %>
                      是否为食品一司
                    </label>
                  </div>
                  <div class="checkbox">
                    <label>
                      <%= f.check_box :user_i_spss, options = {}, checked_value = "1", unchecked_value = "0" %>
                      是否为食品三司
                    </label>
                  </div-->
                </div>
                <br>
            <% end %>

            <div class="panel panel-default">
              <div class="panel-body">
                <label>数据库查看权限设置:</label>
                <br>
                <div class="checkbox"><label>
                  <%= f.check_box :user_i_sp, options = {}, checked_value = "1", unchecked_value = "0" %>食品</span>
                </label></div>
                <hr style="margin: 10px auto;">
                <div class="checkbox"><label>
                  <%= f.check_box :user_d_authority, options = {}, checked_value = "1", unchecked_value = "0" %>填报基本信息
                </label></div>
                <div class="checkbox"><label>
                  <%= f.check_box :user_d_authority_1, options = {}, checked_value = "1", unchecked_value = "0" %>填报检测数据
                </label></div>
                <div class="checkbox"><label>
                  <%= f.check_box :user_d_authority_2, options = {}, checked_value = "1", unchecked_value = "0" %>上报审核
                </label></div>
                <div class="checkbox"><label>
                  <%= f.check_box :user_d_authority_5, options = {}, checked_value = "1", unchecked_value = "0" %>上报批准
                </label></div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-body">
                <label>异议管理权限:</label>
                <br>

                <div class="form-inline">
                  <div class="checkbox">
                    <label><%= f.check_box :yyadmin, options = {}, checked_value = "1", unchecked_value = "0" %>
                      管理员</label>
                  </div>
                  <div class="checkbox">
                    <label><%= f.check_box :yysl, options = {}, checked_value = "1", unchecked_value = "0" %>
                      异议受理</label>
                  </div>
                  <div class="checkbox">
                    <label><%= f.check_box :zhxt, options = {}, checked_value = "1", unchecked_value = "0" %>
                      综合协调</label>
                  </div>
                  <div class="checkbox">
                    <label><%= f.check_box :yybl, options = {}, checked_value = "1", unchecked_value = "0" %>
                      异议办理</label>
                  </div>
                  <div class="checkbox">
                    <label><%= f.check_box :yysh, options = {}, checked_value = "1", unchecked_value = "0" %>
                      异议审核</label>
                  </div>
                </div>
                <br>
                <br>
                <label>后处理权限:</label>
                <br>

                <div class="form-inline">
                  <div class="checkbox">
                    <label><%= f.check_box :hcz_admin, options = {}, checked_value = "1", unchecked_value = "0" %>
                      管理员</label>
                  </div>
                  <div class="checkbox">
                    <label> <%= f.check_box :hcz_czap, options = {}, checked_value = "1", unchecked_value = "0" %>
                      处置安排 </label>
                  </div>
                  <div class="checkbox">
                    <label><%= f.check_box :hcz_czbl, options = {}, checked_value = "1", unchecked_value = "0" %>
                      处置办理</label>
                  </div>
                  <div class="checkbox">
                    <label><%= f.check_box :hcz_czsh, options = {}, checked_value = "1", unchecked_value = "0" %>
                      处置审核</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-body">
                <label>抽检终端权限</label>
                <br>

                <div class="form-inline">
                  <div class="checkbox"><label><%= f.check_box :jsyp %>接收样品</label></div>
                  &emsp;
                  <div class="checkbox"><label><%= f.check_box :zxcy %>执行采样任务</label></div>
                  &emsp;
                  <div class="checkbox"><label><%= f.check_box :rwbs %>任务部署</label></div>
                  &emsp;
                  <div class="checkbox"><label><%= f.check_box :rwxd %>任务下达</label></div>
                </div>
                <br>
                <br>
                <label>系统编号：<!--<i class="text-danger">目前仅限吉林省用</i>--></label>
                <%= f.text_field :car_sys_id, :class => "form-control input-sm" %>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-body">
                <label>抽检数据发布</label>
                <br>

                <div class="form-inline">
                  <div class="checkbox"><label><%= f.check_box :pub_xxfb %>信息发布</label></div>
                  &emsp;
                  <div class="checkbox"><label><%= f.check_box :pub_xxfb_sh %>信息发布审核</label></div>
                </div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-heading">其他</div>
              <div class="panel-body">
                <%= f.check_box :enable_api, options = {}, checked_value = "1", unchecked_value = "0" %>是否启用接口
              </div>
            </div>
        <% end %>
        <br>
        <% if !@user.is_passed? and !current_user.is_super? %>
            <label>审核记录:</label>
            <ul>
              <% @user.user_audit_logs.order('id asc').each do |log| %>
                  <li><%= log.msg %>
                    <small>操作人:<%= log.operator.tname %>,
                      操作时间:<%= log.created_at.strftime('%Y-%m-%d %H:%M:%S') %></small>
                  </li>
              <% end %>
            </ul>
            <input type="hidden" name="account-pass-request" value="1">
            <input type="hidden" name="account-pass" id="account-pass-flag">
            <% if current_user.is_account_manager %>
                <% if (@user.state == User::State::ReviewJG and current_user.is_jg_manager?) or \
                (current_user.user_s_province == @user.user_s_province and @user.state == User::State::ReviewSJ and current_user.is_prov_manager?) %>
                    <button class="btn btn-sm btn-success pass pass-request" data-confirm="确定审核通过该账号吗？">
                      <i class="glyphicon glyphicon-ok"></i>&nbsp;审核通过
                    </button>
                    <button class="btn btn-sm btn-danger deny pass-request" data-confirm="确定决绝该账号的申请吗？">拒绝申请</button>
                <% end %>
            <% elsif @user.id == current_user.id and @user.is_rejected? %>
                <button class="btn btn-sm btn-warning pass pass-request" data-confirm="确定重新提交审核该账号吗？">
                  <i class="glyphicon glyphicon-ok"></i>&nbsp;重新申请
                </button>
            <% end %>
        <% else %>
            <button class="btn btn-sm btn-success" data-confirm="确定保存吗？">提交</button>
        <% end %>
        <%= link_to '返回', users_path, :class => 'btn btn-sm btn-info' %>
    <% end %>
  </div>
</div>
